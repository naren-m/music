<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnatic Music Learning - Western Notes</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .nav-link {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ffd700;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .api-status {
            color: #90EE90;
            font-weight: bold;
        }
        
        .detection-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .mic-button {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            border: none;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            color: white;
            font-size: 2em;
            cursor: pointer;
            margin: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }
        
        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        
        .mic-button.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        .detection-result {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .note-display {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .frequency-display {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-top: 10px;
        }
        
        .confidence-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .confidence-fill {
            background: linear-gradient(90deg, #ff6b6b, #ffd700, #28a745);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .error-message {
            color: #ff6b6b;
            font-weight: bold;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Carnatic Music Learning</h1>
        
        <div class="nav-links">
            <a href="/" class="nav-link active">Western Notes</a>
            <a href="/carnatic" class="nav-link">Carnatic Shruti</a>
            <a href="/learning" class="nav-link">Learning Modules</a>
        </div>
        
        <div class="status">
            <h2>üéØ Western Note Detection Interface</h2>
            <p>Traditional 12-tone equal temperament system</p>
            <p class="api-status">API Status: ‚úÖ Active (v2.0.0)</p>
        </div>
        
        <div class="feature">
            <h3>üéº Features Available</h3>
            <ul>
                <li>Real-time pitch detection</li>
                <li>Note identification (C, C#, D, etc.)</li>
                <li>Frequency analysis</li>
                <li>WebSocket real-time feedback</li>
            </ul>
        </div>
        
        <div class="feature">
            <h3>üîó API Endpoints</h3>
            <ul>
                <li><strong>Health Check:</strong> <code>/api/v1/health</code></li>
                <li><strong>Audio Processing:</strong> <code>/api/v1/audio/*</code></li>
                <li><strong>Authentication:</strong> <code>/api/v1/auth/*</code></li>
                <li><strong>Social Features:</strong> <code>/api/v1/social/*</code></li>
            </ul>
        </div>
        
        <div class="detection-panel">
            <h3>üé§ Real-Time Note Detection</h3>
            <p>Click the microphone to start detecting notes from your voice or instrument</p>
            
            <button id="micButton" class="mic-button" onclick="toggleMicrophone()">
                üé§
            </button>
            
            <div id="detectionResult" class="detection-result">
                <div>Click microphone to start detection</div>
            </div>
            
            <div class="confidence-bar">
                <div id="confidenceFill" class="confidence-fill" style="width: 0%;"></div>
            </div>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
        
        <div class="feature">
            <h3>üöÄ Getting Started</h3>
            <p>This is the main interface for western note detection. Use the navigation above to explore:</p>
            <ul>
                <li><strong>Carnatic Shruti:</strong> 22-shruti detection system</li>
                <li><strong>Learning Modules:</strong> Progressive Carnatic music education</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Audio detection variables
        let mediaRecorder;
        let audioContext;
        let isRecording = false;
        let analyser;
        let dataArray;
        let animationFrame;
        
        // Check API health on page load
        fetch('/api/v1/health')
            .then(response => response.json())
            .then(data => {
                console.log('API Health:', data);
                if (data.status === 'healthy') {
                    document.querySelector('.api-status').innerHTML = 
                        `API Status: ‚úÖ Active (v${data.version})`;
                }
            })
            .catch(error => {
                console.error('API Error:', error);
                document.querySelector('.api-status').innerHTML = 
                    'API Status: ‚ùå Unavailable';
            });
        
        async function toggleMicrophone() {
            const micButton = document.getElementById('micButton');
            const errorMessage = document.getElementById('errorMessage');
            
            if (!isRecording) {
                try {
                    await startRecording();
                    micButton.classList.add('active');
                    micButton.innerHTML = 'üõë';
                    isRecording = true;
                    errorMessage.style.display = 'none';
                } catch (error) {
                    console.error('Error starting recording:', error);
                    showError('Microphone access denied or not available');
                }
            } else {
                stopRecording();
                micButton.classList.remove('active');
                micButton.innerHTML = 'üé§';
                isRecording = false;
            }
        }
        
        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false,
                    sampleRate: 44100
                } 
            });
            
            // Create audio context for analysis
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            
            analyser.fftSize = 8192;
            analyser.smoothingTimeConstant = 0.3;
            source.connect(analyser);
            
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            // Start continuous analysis
            analyzeAudio();
        }
        
        function stopRecording() {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            updateDetectionResult('Click microphone to start detection', 0, 0);
        }
        
        function analyzeAudio() {
            if (!analyser || !isRecording) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Find peak frequency
            let maxIndex = 0;
            let maxValue = 0;
            
            for (let i = 1; i < dataArray.length; i++) {
                if (dataArray[i] > maxValue) {
                    maxValue = dataArray[i];
                    maxIndex = i;
                }
            }
            
            // Convert bin index to frequency
            const sampleRate = audioContext.sampleRate;
            const frequency = (maxIndex * sampleRate) / (analyser.fftSize * 2);
            
            // Check if there's significant audio signal
            if (maxValue > 50 && frequency > 80 && frequency < 2000) {
                const confidence = Math.min(maxValue / 255, 1.0);
                const note = frequencyToNote(frequency);
                updateDetectionResult(note, frequency, confidence);
            } else {
                updateDetectionResult('No signal detected', 0, 0);
            }
            
            // Continue analysis
            animationFrame = requestAnimationFrame(analyzeAudio);
        }
        
        function frequencyToNote(frequency) {
            if (frequency <= 0) return 'N/A';
            
            // A4 = 440 Hz reference
            const A4 = 440.0;
            const C0 = A4 * Math.pow(2, -4.75);
            
            // Calculate semitones from C0
            const semitones = 12 * Math.log2(frequency / C0);
            const noteNumber = Math.round(semitones);
            
            // Note names
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(noteNumber / 12);
            const noteIndex = ((noteNumber % 12) + 12) % 12;
            
            return `${noteNames[noteIndex]}${octave}`;
        }
        
        function updateDetectionResult(note, frequency, confidence) {
            const resultDiv = document.getElementById('detectionResult');
            const confidenceFill = document.getElementById('confidenceFill');
            
            if (note && note !== 'No signal detected' && note !== 'N/A') {
                resultDiv.innerHTML = `
                    <div class="note-display">${note}</div>
                    <div class="frequency-display">${frequency.toFixed(1)} Hz</div>
                `;
            } else {
                resultDiv.innerHTML = `<div>${note || 'No signal detected'}</div>`;
            }
            
            // Update confidence bar
            const confidencePercent = (confidence * 100).toFixed(0);
            confidenceFill.style.width = `${confidencePercent}%`;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Check for microphone support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError('Microphone access not supported in this browser');
        }
    </script>
</body>
</html>